<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>í—¤ì•„ë¦¼ â€” ë…¸ì¸ ë°œìŒ ë²ˆì—­ê¸° + RAG íŒ¨ë„</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root{ --ring:#60A5FA }
  html,body{background:linear-gradient(160deg,#0b1020,#101836 40%,#0b1020); color:#e5e7eb}
  .glass{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08); backdrop-filter: blur(10px)}
  .focus-ring:focus-visible{outline:3px solid var(--ring); outline-offset:2px; border-radius:12px}
  .bar{width:4px; border-radius:2px; animation:wave 1200ms ease-in-out infinite}
  .bar:nth-child(odd){animation-delay:300ms}
  .bar:nth-child(3n){animation-delay:600ms}
  @keyframes wave{0%,100%{height:6px} 50%{height:28px}}
  .pulse::after{content:""; position:absolute; inset:-8px; border-radius:9999px; border:2px solid rgba(99,102,241,.5); animation:pulse 1.6s infinite}
  @keyframes pulse{0%{opacity:.7; transform:scale(.9)}70%{opacity:0; transform:scale(1.15)}100%{opacity:0}}
  mark{background:rgba(250,204,21,.35); padding:0 .2em; border-radius:.25rem}
  .shadow-scroll{mask-image: linear-gradient(to bottom, transparent 0, black 18px, black calc(100% - 18px), transparent 100%)}
  .scalable{font-size:clamp(18px,2.2vw,28px); line-height:1.4}
  .scalable-sm{font-size:clamp(14px,1.2vw,18px); line-height:1.4}
  .badge{font-size:12px; padding:.2rem .5rem; border-radius:999px; border:1px solid rgba(255,255,255,.2)}
</style>
</head>
<body>
  <!-- HEADER -->
  <header class="max-w-7xl mx-auto px-4 pt-6 pb-4">
    <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-xl bg-indigo-500/20 grid place-items-center">
          <svg width="20" height="20" fill="none" viewBox="0 0 24 24">
            <path d="M12 3v10a4 4 0 1 1-8 0" stroke="#93a4ff" stroke-width="2" stroke-linecap="round"/>
            <rect x="10" y="2" width="4" height="12" rx="2" fill="#93a4ff"/>
            <path d="M5 13v2a7 7 0 0 0 14 0v-2" stroke="#93a4ff" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div>
          <h1 class="text-xl sm:text-2xl font-semibold">í—¤ì•„ë¦¼ â€” ë…¸ì¸ ë°œìŒ ë²ˆì—­ê¸°</h1>
          <p class="text-slate-400 text-sm">RAGë¡œ ê°œì¸ë³„ ê³¼ê±° ì´ë ¥/ì–¸ì–´ë°ì´í„°ê¹Œì§€ í•œ í™”ë©´ì—</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <select id="langSelect" class="glass px-3 py-2 rounded-xl"> 
          <option value="ko-KR" selected>í•œêµ­ì–´ (ko-KR)</option>
          <option value="en-US">ì˜ì–´ (en-US)</option>
        </select>
        <button id="btnStart" class="relative pulse px-4 py-2 rounded-xl bg-indigo-500 hover:bg-indigo-600 focus-ring">ğŸ™ï¸ ì‹œì‘</button>
        <button id="btnStop" class="px-4 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 focus-ring">â¹ï¸ ì •ì§€</button>
      </div>
    </div>
  </header>

  <!-- MAIN GRID -->
  <main class="max-w-7xl mx-auto px-4 pb-28">
    <div class="grid lg:grid-cols-3 gap-6">
      <!-- LEFT: MIC -->
      <section class="glass rounded-2xl p-5">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold">ì…ë ¥ ì¥ì¹˜</h2>
          <div class="flex items-center gap-2 text-sm text-slate-300">
            <div id="micDot" class="h-3 w-3 rounded-full bg-slate-500"></div> ë§ˆì´í¬
          </div>
        </div>
        <div class="grid sm:grid-cols-2 gap-4">
          <div class="rounded-2xl border border-white/10 p-4 bg-white/5">
            <div class="h-16 flex items-end gap-1">
              <div class="bar bg-indigo-400"></div><div class="bar bg-indigo-400"></div><div class="bar bg-indigo-400"></div>
              <div class="bar bg-indigo-400"></div><div class="bar bg-indigo-400"></div><div class="bar bg-indigo-400"></div>
              <div class="bar bg-indigo-400"></div><div class="bar bg-indigo-400"></div><div class="bar bg-indigo-400"></div>
              <div class="bar bg-indigo-400"></div>
            </div>
            <p class="text-xs text-slate-400 mt-2">* ì ‘ê·¼ì„± ì¤‘ì‹¬ ê°„ë‹¨ ì‹œê°í™”</p>
          </div>
          <div class="rounded-2xl border border-white/10 p-4 bg-white/5">
            <div class="text-sm text-slate-300 mb-2">ë¹ ë¥¸ ë¬¸êµ¬(í…ŒìŠ¤íŠ¸)</div>
            <div class="flex flex-wrap gap-2">
              <button class="quick glass px-3 py-2 rounded-xl text-sm" data-utter="ë¬¼ ì¢€... ì¤˜ë³´ì†Œ...">â€œë¬¼ ì¢€... ì¤˜ë³´ì†Œ...â€</button>
              <button class="quick glass px-3 py-2 rounded-xl text-sm" data-utter="ë°°ê°€ ì°Œë¦¿í•´ìš”...">â€œë°°ê°€ ì°Œë¦¿í•´ìš”â€¦â€</button>
              <button class="quick glass px-3 py-2 rounded-xl text-sm" data-utter="ì˜ì¹˜ê°€ ê³„ì† ë¹ ì ¸ìš”">â€œì˜ì¹˜ê°€ ê³„ì† ë¹ ì ¸ìš”â€</button>
              <button class="quick glass px-3 py-2 rounded-xl text-sm" data-utter="í™”ì¥ì‹¤ ì–´ë””â€¦ ê¸‰í•´ìš”">â€œí™”ì¥ì‹¤ ì–´ë””â€¦ ê¸‰í•´ìš”â€</button>
            </div>
          </div>
        </div>
        <ul class="text-slate-300 text-sm list-disc ml-5 mt-4">
          <li>ì§§ê³  ì²œì²œíˆ ë§ì”€í•´ ì£¼ì„¸ìš”.</li>
          <li>ì£¼ë³€ ì†ŒìŒì„ ì¤„ì´ë©´ ì¸ì‹ë¥ ì´ ì˜¬ë¼ê°‘ë‹ˆë‹¤.</li>
        </ul>
      </section>

      <!-- CENTER: LIVE CAPTION -->
      <section class="glass rounded-2xl p-5">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold">ì‹¤í™© ìº¡ì…˜(ì›ë¬¸)</h2>
          <div class="flex items-center gap-3">
            <label class="text-sm text-slate-300">ê¸€ì í¬ê¸°</label>
            <input id="fontRange" type="range" min="16" max="36" value="26" class="w-32"/>
          </div>
        </div>
        <div id="liveText" class="scalable min-h-[160px] rounded-xl border border-white/10 p-4 bg-black/20"></div>
        <div class="mt-4 flex items-center justify-between">
          <div class="text-slate-300 text-sm">ë¶€ë¶„ê²°ê³¼ëŠ” íšŒìƒ‰, í™•ì •ë¬¸ì¥ì€ íŒŒë€ìƒ‰ìœ¼ë¡œ ë¡œê·¸ì— ì €ì¥ë©ë‹ˆë‹¤.</div>
          <div class="flex gap-2">
            <button id="btnCopy"  class="px-3 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-sm">ë³µì‚¬</button>
            <button id="btnClear" class="px-3 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-sm">ì´ˆê¸°í™”</button>
          </div>
        </div>
        <div id="log" class="mt-3 max-h-40 overflow-auto pr-2 shadow-scroll"></div>
      </section>

      <!-- RIGHT: TRANSLATION + INTENT + PATIENT PICKER -->
      <section class="glass rounded-2xl p-5">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold">í‘œì¤€ë¬¸ì¥ & ì˜ë„</h2>
          <span id="confidence" class="text-sm text-slate-400">ì‹ ë¢°ë„: -</span>
        </div>
        <div class="rounded-2xl border border-white/10 p-4 bg-white/5">
          <div class="text-slate-400 text-sm mb-1">í‘œì¤€ë¬¸ì¥</div>
          <div id="stdText" class="scalable text-indigo-200 font-medium">-</div>
        </div>
        <div class="grid sm:grid-cols-2 gap-3 mt-3">
          <div class="rounded-2xl border border-white/10 p-4 bg-white/5">
            <div class="text-slate-400 text-sm mb-1">ì˜ë„(ì¹´í…Œê³ ë¦¬)</div>
            <div id="intent" class="text-lg">-</div>
          </div>
          <div class="rounded-2xl border border-white/10 p-4 bg-white/5">
            <div class="text-slate-400 text-sm mb-1">ë‹¨ì„œ(ë§¤ì¹­ì–´)</div>
            <div id="clues" class="scalable-sm text-slate-200">-</div>
          </div>
        </div>

        <hr class="my-4 border-white/10">
        <div class="flex flex-col gap-2">
          <div class="text-slate-300 text-sm">í™˜ì ì„ íƒ</div>
          <div class="flex gap-2">
            <select id="patientSelect" class="glass px-3 py-2 rounded-xl grow">
              <option value="p001" selected>p001 â€” ê¹€OO(78ì„¸, F)</option>
              <option value="p002">p002 â€” ë°•OO(82ì„¸, F)</option>
              <option value="p003">p003 â€” ì´OO(76ì„¸, M)</option>
            </select>
            <input id="ragQuery" placeholder="RAG í‚¤ì›Œë“œ(ì˜ˆ: ë¬¼, ë³µí†µ, í‹€ë‹ˆ)" class="glass px-3 py-2 rounded-xl w-40"/>
            <button id="btnRag" class="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500">RAG ê²€ìƒ‰</button>
          </div>
          <p class="text-xs text-slate-400">* ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„  ì¸ì¦Â·ì ‘ê·¼ê¶Œí•œÂ·ê°ì‚¬ë¡œê·¸ ë“± PHI ë³´í˜¸ í•„ìˆ˜</p>
        </div>
      </section>
    </div>

    <!-- BOTTOM: RAG PANELS -->
    <section class="glass rounded-2xl p-5 mt-6">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-semibold">ê°œì¸ë³„ ê³¼ê±° ì²˜ë°© ì´ë ¥</h2>
        <span id="rxCount" class="badge">0ê±´</span>
      </div>
      <div class="overflow-auto rounded-xl border border-white/10">
        <table class="min-w-full text-sm">
          <thead class="bg-white/5">
            <tr class="text-left">
              <th class="px-3 py-2">ë‚ ì§œ</th>
              <th class="px-3 py-2">ì§„ë‹¨/ì¦ìƒ</th>
              <th class="px-3 py-2">ì²˜ë°©ì•½(ì„±ë¶„)</th>
              <th class="px-3 py-2">ìš©ë²•</th>
              <th class="px-3 py-2">ë‹´ë‹¹ì˜</th>
            </tr>
          </thead>
          <tbody id="rxBody" class="divide-y divide-white/10"></tbody>
        </table>
      </div>
    </section>

    <section class="glass rounded-2xl p-5 mt-6">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-semibold">ê°œì¸ë³„ ê³¼ê±° ì–¸ì–´ë°ì´í„° (RAG Top-K)</h2>
        <div class="flex items-center gap-2">
          <span class="text-slate-300 text-sm">K</span>
          <input id="topK" type="number" min="1" max="10" value="5" class="glass w-16 px-2 py-1 rounded-lg"/>
        </div>
      </div>
      <div id="speechList" class="grid md:grid-cols-2 gap-3"></div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="max-w-7xl mx-auto px-4 py-6 text-center text-slate-500 text-sm">
    Â© 2025 í—¤ì•„ë¦¼ â€” ì‹¤í—˜ì  ë°ëª¨. ì‹¤ì œ ìš´ì˜ ì‹œ ê°œì¸ì •ë³´ë³´í˜¸/ë™ì˜/ì ‘ê·¼í†µì œ í•„ìˆ˜.
  </footer>

<script>
/* -----------------------------
   0) ê³µí†µ ìœ í‹¸
------------------------------*/
const $ = (s)=>document.querySelector(s);
const escapeHTML = s => (s||"").replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[m]));
const highlight = (text, q) => {
  if(!q) return escapeHTML(text);
  const re = new RegExp('('+q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','gi');
  return escapeHTML(text).replace(re,'<mark>$1</mark>');
};

/* -----------------------------
   (1) ìœ í‹¸ & ê°„ë‹¨ ë™ì˜ì–´ ì‚¬ì „  âœ… ì¶”ê°€
------------------------------*/
function splitKeywords(q){ return (q||'').split(/[,/ ]+/).map(s=>s.trim()).filter(Boolean); }
const SYN = {
  "ë¬¼":["ë¬¼","ê°ˆì¦","ëª©ë§ˆë¦„","ì…ë§ˆë¦„","ìˆ˜ë¶„","ê²½êµ¬ìˆ˜ì•¡","ORS"],
  "ë³µí†µ":["ë³µí†µ","ë°°ì•„í””","ì†ì“°ë¦¼","ìœ„ì—¼","ëª…ì¹˜","ìƒë³µë¶€","PPI","ì—ì†Œë©”í”„ë¼ì¡¸","esomeprazole"],
  "í‹€ë‹ˆ":["í‹€ë‹ˆ","ì˜ì¹˜","ì‡ëª¸","êµ¬ê°•","ì”¹ê¸°","ì˜ì¹˜ì••í†µ"],
  "í™”ì¥ì‹¤":["í™”ì¥ì‹¤","ë°°ë‡¨","ì˜¤ì¤Œ","ì‰¬ì•¼","ìš”ë¡œ","ìš”ë¡œê°ì—¼","UTI"],
  "í—ˆë¦¬":["í—ˆë¦¬","ìš”í†µ"],
  "ì•½":["ì•½","ì§„í†µì œ","ì•„ì„¸íŠ¸ì•„ë¯¸ë…¸íœ","acetaminophen","NSAIDs","ë‚˜í”„ë¡ì„¼","naproxen"],
  "í•­ìƒì œ":["í•­ìƒì œ","Ciprofloxacin","ì‹œí”„ë¡œí”Œë¡ì‚¬ì‹ ","Cipro"]
};
function extractKeywordsFromText(s){
  const t=(s||'').toLowerCase();
  const base=[];
  Object.keys(SYN).forEach(k=>{
    if([k,...SYN[k].map(x=>x.toLowerCase())].some(w=>t.includes(w))) base.push(k);
  });
  const toks=(t.match(/[ê°€-í£A-Za-z0-9]+/g)||[])
    .filter(x=>x.length>=2)
    .filter(x=>!['ì…ë‹ˆë‹¤','í•˜ì„¸ìš”','ê·¸ë¦¬ê³ ','ì˜¤ëŠ˜','ì¢€','ì¡°ê¸ˆ','ì •ë§'].includes(x));
  const bag=Array.from(new Set([...base,...toks])).slice(0,8);
  const expanded=new Set();
  bag.forEach(k=>{
    expanded.add(k);
    if(SYN[k]) SYN[k].forEach(v=>expanded.add(v.toLowerCase()));
  });
  return Array.from(expanded);
}
function relevanceToPatient(pid, terms){
  const P = DEMO[pid]||{rx:[],speech:[]};
  const blob = [
    ...P.rx.map(r=>`${r.dx} ${r.drug} ${r.dose} ${r.doctor}`),
    ...P.speech.map(s=>`${s.text} ${s.context} ${(s.tags||[]).join(' ')}`)
  ].join(' ').toLowerCase();
  let score=0;
  terms.forEach(t=>{ if(blob.includes(t.toLowerCase())) score++; });
  return score;
}
function mergeRagAndRun(terms){
  const cur = splitKeywords(ragQuery.value.toLowerCase());
  const merged = Array.from(new Set([...cur, ...terms.map(t=>t.toLowerCase())]))
    .filter(Boolean).slice(0,10);
  ragQuery.value = merged.join(', ');
  runRAG();
}

/* -----------------------------
   1) ì˜ë„ ê·œì¹™ (ê°„ë‹¨ ë°ëª¨) - ì›ë³¸ ê·¸ëŒ€ë¡œ
------------------------------*/
const KB = [
  /* ... (ìƒëµ: ì›ë³¸ KB ë°°ì—´ ê·¸ëŒ€ë¡œ) ... */
  {"category":"ë¶“ê¸°","standard":"ë‹¤ë¦¬ê°€ ë¶€ì—ˆì–´ìš”.","variants":["ë°œ/ì¢…ì•„ë¦¬ ë¶“ê¸°","í‘¸ì„í‘¸ì„ ë¶€ì–´ìš”","ë¬´ê²ê³  ë‹¹ê²¨ìš”","í•œìª½ë§Œ ë¶€ì–´ìš”","ë‹¤ë¦¬ ë¶“ëŠ”ë‹¤ì˜ˆ","ë°œì´ í‰í‰ ë¶“ì‰","ë‹¤ë¦¬ ë»ê·¼í—ˆë„¤","ë‹¤ë¦¬ í‰í‰ ë¶€ì—ˆì–´ìœ "]}
];
function localIntentMatch(text){
  const t=(text||"").toLowerCase();
  let best={category:"-",standard:"-",clues:[],score:0};
  for(const item of KB){
    let score=0, clues=[];
    for(const v of item.variants){
      const vv=v.replace(/\s+/g,"").toLowerCase();
      if(t.includes(vv) || t.includes(v.toLowerCase())){ score++; clues.push(v); }
    }
    if(score>best.score) best={category:item.category, standard:item.standard, clues, score};
  }
  const conf=best.score===0?0.2:Math.min(0.2+best.score*0.2,0.95);
  return {...best, confidence: conf};
}

/* -----------------------------
   2) ë°ëª¨ìš© í™˜ì ë°ì´í„°
------------------------------*/
const DEMO = {
  p001:{ rx:[
      {date:"2025-06-10", dx:"ìƒë³µë¶€ í†µì¦(ìœ„ì—¼ ì˜ì‹¬)", drug:"PPI(esomeprazole 20mg)", dose:"1ì • qd ì•„ì¹¨ ì‹ì „", doctor:"ì •OO"},
      {date:"2025-03-02", dx:"êµ¬ê°• í†µì¦(ì˜ì¹˜ ì••í†µ)",   drug:"Acetaminophen 500mg",   dose:"1ì • tid í•„ìš”ì‹œ", doctor:"ìœ OO"},
      {date:"2024-12-21", dx:"íƒˆìˆ˜ ì˜ì‹¬",              drug:"ORS ê²½êµ¬ìˆ˜ì•¡",          dose:"í¬ 1ê°œ í•„ìš”ì‹œ",  doctor:"ì •OO"},
    ],
    speech:[
      {text:"ëª°ì¤Œâ€¦ ëª©ì´ ì¹¼ì¹¼í•˜ë‹¤ ì¹´ì´", context:"ì˜¤í›„ ì™¸ë˜ ëŒ€ê¸° ì¤‘ ë¬¼ ìš”ì²­", tags:["ìŒë£Œìš”ì²­"], score:0.86},
      {text:"ì´ê°€ ëœê·¸ëŸ­ê±°ë¦¬ê³  ì”¹ê¸° í˜ë“¤ì–´ì˜ˆ", context:"ì˜ì¹˜ ë¶ˆí¸ í˜¸ì†Œ", tags:["êµ¬ê°•/ì˜ì¹˜"], score:0.82},
      {text:"ì†ì´ ì“°ë ¤ê°€ê¼¬ ë°¥ ë§›ì´ ì—†ë°ì´", context:"ì†Œí™”ë¶ˆëŸ‰/ìœ„ì—¼ ì˜ì‹¬", tags:["í†µì¦"], score:0.79},
      {text:"ë³¼ì¼ ì¢€ ê¸‰í•œë° í™”ì¥ì‹¤ ì–´ë”¥ë‹ˆêº¼", context:"í™”ì¥ì‹¤ ìœ„ì¹˜ ë¬¸ì˜", tags:["í™”ì¥ì‹¤"], score:0.77},
      {text:"ëª© íƒ€ ì£½ê² ë‹¤ ì•„ì´ê°€", context:"ë”ìœ„/íƒˆìˆ˜ ì˜ì‹¬", tags:["ìŒë£Œìš”ì²­"], score:0.74},
    ]
  },
  p002:{ rx:[
      {date:"2025-07-01", dx:"ìš”ë¡œê°ì—¼ ì¹˜ë£Œ", drug:"Ciprofloxacin 250mg", dose:"1ì • bid 7ì¼", doctor:"ë°•OO"},
      {date:"2025-01-14", dx:"ë¬´ë¦ í†µì¦", drug:"NSAIDs(Naproxen 250mg)", dose:"1ì • bid ì‹í›„", doctor:"ê¹€OO"},
    ],
    speech:[
      {text:"ë¬¼ í•œ ì”ë§Œ ì£¼ì†Œ", context:"ì ‘ìˆ˜ ì°½êµ¬", tags:["ìŒë£Œìš”ì²­"], score:0.81},
      {text:"ì‰¬ ë§ˆë ¤ì›Œìš”â€¦", context:"ì§„ë£Œ ì „", tags:["í™”ì¥ì‹¤"], score:0.78},
      {text:"ì´ê°€ í—ê±°ì›Œì„œ ë°¥ì„ ëª» ë¨¹ì–´", context:"ì˜ì–‘ ì„­ì·¨ê³¤ë€", tags:["êµ¬ê°•/ì˜ì¹˜"], score:0.76},
    ]
  },
  p003:{ rx:[
      {date:"2025-05-09", dx:"ìš”í†µ", drug:"Acetaminophen 500mg", dose:"1ì • tid", doctor:"ë‚¨OO"},
    ],
    speech:[
      {text:"ë°°ê°€ ì°Œë¦¿í•˜ë„¤", context:"ì‘ê¸‰ì‹¤ íŠ¸ë¦¬ì•„ì§€", tags:["í†µì¦"], score:0.69},
      {text:"í™”ì¥ì‹¤â€¦ ê¸‰í•´ìš”", context:"ë³µë„", tags:["í™”ì¥ì‹¤"], score:0.67},
    ]
  }
};

/* -----------------------------
   3) ë°±ì—”ë“œ ì—°ë™ í›…(ëª¨ì˜)
------------------------------*/
async function fetchPrescriptions(patientId, query){
  const rows = (DEMO[patientId]?.rx||[])
    .filter(r=>!query || JSON.stringify(r).toLowerCase().includes(query.toLowerCase()));
  return rows;
}
async function fetchSpeechRAG(patientId, query, topK=5){
  let items = (DEMO[patientId]?.speech||[]);
  if(query){
    const q = query.toLowerCase();
    items = items.map(o=>{
      const hit = (o.text+o.context+o.tags.join(',')).toLowerCase().includes(q);
      return {...o, score: o.score + (hit?0.05:0)};
    });
  }
  return items.sort((a,b)=>b.score-a.score).slice(0, topK);
}

/* -----------------------------
   4) UI ë°”ì¸ë”©
------------------------------*/
const liveText = $('#liveText'), log = $('#log'), stdText = $('#stdText'), intentEl = $('#intent'), cluesEl = $('#clues'), confEl = $('#confidence');
const micDot = $('#micDot'); const btnStart = $('#btnStart'); const btnStop = $('#btnStop'); const fontRange = $('#fontRange'); const langSelect = $('#langSelect');
const btnCopy = $('#btnCopy'); const btnClear = $('#btnClear');
const patientSelect = $('#patientSelect'); const ragQuery = $('#ragQuery'); const btnRag = $('#btnRag'); const rxBody = $('#rxBody'); const rxCount = $('#rxCount');
const speechList = $('#speechList'); const topK = $('#topK');

let recognizing=false, recognition=null;

function appendLog(text, final=false){
  const line=document.createElement('div'); line.className='mb-1';
  const badge = final
    ? '<span class="text-xs px-2 py-0.5 rounded-full bg-indigo-500/30 border border-indigo-400/30 mr-2">í™•ì •</span>'
    : '<span class="text-xs px-2 py-0.5 rounded-full bg-slate-500/30 border border-slate-400/30 mr-2">ë¶€ë¶„</span>';
  line.innerHTML = badge + `<span class="${final?'text-indigo-200':'text-slate-300'}">${escapeHTML(text)}</span>`;
  log.appendChild(line); log.scrollTop = log.scrollHeight;
}
function setMic(on){ micDot.className='h-3 w-3 rounded-full '+(on?'bg-emerald-400':'bg-slate-500'); }

function renderRx(rows, q){
  rxBody.innerHTML = rows.map(r=>`
    <tr>
      <td class="px-3 py-2 whitespace-nowrap">${highlight(r.date,q)}</td>
      <td class="px-3 py-2">${highlight(r.dx,q)}</td>
      <td class="px-3 py-2">${highlight(r.drug,q)}</td>
      <td class="px-3 py-2">${highlight(r.dose,q)}</td>
      <td class="px-3 py-2 whitespace-nowrap">${highlight(r.doctor,q)}</td>
    </tr>`).join('');
  rxCount.textContent = `${rows.length}ê±´`;
}
function renderSpeech(items, q){
  speechList.innerHTML = items.map(o=>`
    <div class="rounded-xl border border-white/10 p-4 bg-white/5">
      <div class="flex items-center justify-between mb-1">
        <div class="badge">${(o.score*100).toFixed(0)}ì </div>
        <div class="text-xs text-slate-400">${o.tags.map(t=>`#${t}`).join(' ')}</div>
      </div>
      <div class="font-medium mb-1">${highlight(o.text,q)}</div>
      <div class="text-sm text-slate-300">ë§¥ë½: ${highlight(o.context,q)}</div>
    </div>`).join('');
}

async function runRAG(){
  const pid = patientSelect.value, q = ragQuery.value.trim();
  const [rx, sp] = await Promise.all([fetchPrescriptions(pid,q), fetchSpeechRAG(pid,q, +topK.value || 5)]);
  renderRx(rx, q); renderSpeech(sp, q);
}
btnRag.addEventListener('click', runRAG);
topK.addEventListener('change', runRAG);
ragQuery.addEventListener('keydown', (e)=>{ if(e.key==='Enter') runRAG(); });

// (3) í™˜ì ë³€ê²½ ì‹œ placeholder íŒíŠ¸ ë™ì  ê°±ì‹  âœ… ì¶”ê°€
patientSelect.addEventListener('change', ()=>{
  const pid = patientSelect.value;
  const hintTerms = extractKeywordsFromText(
    (DEMO[pid]?.rx.map(r=>`${r.dx} ${r.drug}`).join(' ')||'') + ' ' +
    (DEMO[pid]?.speech.map(s=>`${s.text} ${s.context}`).join(' ')||'')
  ).slice(0,3);
  ragQuery.placeholder = hintTerms.length ? `RAG í‚¤ì›Œë“œ(ì˜ˆ: ${hintTerms.join(', ')})`
                                          : 'RAG í‚¤ì›Œë“œ(ì˜ˆ: ë¬¼, ë³µí†µ, í‹€ë‹ˆ)';
  runRAG();
});

/* -----------------------------
   5) (ë°ëª¨) Web Speech API
------------------------------*/
function initRecognition(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ì‹¤ì‹œê°„ ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Chrome ê¶Œì¥ ë˜ëŠ” ë°±ì—”ë“œ ASR ì—°ê²°ì„ ì‚¬ìš©í•˜ì„¸ìš”."); return null; }
  const rec = new SR(); rec.continuous = true; rec.interimResults = true; rec.lang = langSelect.value||'ko-KR'; rec.maxAlternatives=1;
  rec.onstart = ()=>{ recognizing=true; setMic(true); };
  rec.onend   = ()=>{ recognizing=false; setMic(false); };
  rec.onresult = async (event)=>{
    let interim='', finalText='';
    for(let i=event.resultIndex;i<event.results.length;i++){
      const res=event.results[i]; const t=res[0].transcript.trim();
      if(res.isFinal){ finalText += t + ' '; } else { interim += t + ' '; }
    }
    if(interim){
      liveText.innerHTML = `<span class="text-slate-300">${escapeHTML(interim)}</span>`;
      appendLog(interim,false);
      const r=localIntentMatch(interim);
      stdText.textContent = r.standard!=="-"?r.standard:interim;
      intentEl.textContent = r.category||'-';
      cluesEl.textContent = r.clues?.join(', ')||'-';
      confEl.textContent = `ì‹ ë¢°ë„: ${Math.round((r.confidence||0)*100)}%`;
    }
    if(finalText){
      liveText.innerHTML = `<span class="text-indigo-200">${escapeHTML(finalText)}</span>`;
      appendLog(finalText,true);
      const r=localIntentMatch(finalText);
      stdText.textContent = r.standard!=="-"?r.standard:finalText;
      intentEl.textContent = r.category||'-';
      cluesEl.textContent = r.clues?.join(', ')||'-';
      confEl.textContent = `ì‹ ë¢°ë„: ${Math.round((r.confidence||0)*100)}%`;

      // (2) ì¸ì‹ ê²°ê³¼ì—ì„œ ìë™ ì—…ë°ì´íŠ¸ í›… âœ… ì¶”ê°€
      const pid = patientSelect.value;
      const baseTerms = [];
      if(r.category && r.category !== '-') baseTerms.push(r.category);
      if(r.standard && r.standard !== '-') baseTerms.push(r.standard);
      const terms = Array.from(new Set([
        ...extractKeywordsFromText(finalText),
        ...extractKeywordsFromText(baseTerms.join(' '))
      ]));
      const rel = relevanceToPatient(pid, terms);
      if(rel >= 1){
        const pick = terms
          .sort((a,b)=>{
            const aSyn = SYN[a]?1:0, bSyn = SYN[b]?1:0;
            if(aSyn!==bSyn) return bSyn-aSyn;
            return b.length - a.length;
          })
          .slice(0,3);
        mergeRagAndRun(pick);
      }
    }
  };
  return rec;
}

btnStart.addEventListener('click', ()=>{
  if(recognizing) return;
  recognition = initRecognition();
  if(recognition){ recognition.lang = langSelect.value; recognition.start(); }
});
btnStop.addEventListener('click', ()=>{ if(recognition && recognizing) recognition.stop(); });
fontRange.addEventListener('input', e=>{ const px=e.target.value+'px'; liveText.style.fontSize=px; stdText.style.fontSize=px; });
btnCopy.addEventListener('click', ()=>{
  const texts=[...log.querySelectorAll('div span:last-child')].map(n=>n.textContent.trim()).join('\n');
  navigator.clipboard.writeText(texts || (liveText.textContent||''));
});
btnClear.addEventListener('click', ()=>{ log.innerHTML=''; liveText.textContent=''; stdText.textContent='-'; intentEl.textContent='-'; cluesEl.textContent='-'; confEl.textContent='ì‹ ë¢°ë„: -'; });

// ì´ˆê¸° ë¡œë“œ
(function init(){
  // ì‹œì‘ ì‹œ í™˜ì íŒíŠ¸ placeholder ì„¤ì •
  const pid = patientSelect.value;
  const hintTerms = extractKeywordsFromText(
    (DEMO[pid]?.rx.map(r=>`${r.dx} ${r.drug}`).join(' ')||'') + ' ' +
    (DEMO[pid]?.speech.map(s=>`${s.text} ${s.context}`).join(' ')||'')
  ).slice(0,3);
  ragQuery.placeholder = hintTerms.length ? `RAG í‚¤ì›Œë“œ(ì˜ˆ: ${hintTerms.join(', ')})`
                                          : 'RAG í‚¤ì›Œë“œ(ì˜ˆ: ë¬¼, ë³µí†µ, í‹€ë‹ˆ)';
  runRAG();
})();
</script>
</body>
</html>
