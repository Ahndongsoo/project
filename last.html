<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>헤아림 — 노인 발음 번역기 + RAG 패널</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root{ --ring:#60A5FA }
  html,body{background:linear-gradient(160deg,#0b1020,#101836 40%,#0b1020); color:#e5e7eb}
  .glass{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08); backdrop-filter: blur(10px)}
  .focus-ring:focus-visible{outline:3px solid var(--ring); outline-offset:2px; border-radius:12px}
  .bar{width:4px; border-radius:2px; animation:wave 1200ms ease-in-out infinite}
  .bar:nth-child(odd){animation-delay:300ms} .bar:nth-child(3n){animation-delay:600ms}
  @keyframes wave{0%,100%{height:6px} 50%{height:28px}}
  .pulse::after{content:""; position:absolute; inset:-8px; border-radius:9999px; border:2px solid rgba(99,102,241,.5); animation:pulse 1.6s infinite}
  @keyframes pulse{0%{opacity:.7; transform:scale(.9)}70%{opacity:0; transform:scale(1.15)}100%{opacity:0}}
  mark{background:rgba(250,204,21,.35); padding:0 .2em; border-radius:.25rem}
  .shadow-scroll{mask-image: linear-gradient(to bottom, transparent 0, black 18px, black calc(100% - 18px), transparent 100%)}
  .scalable{font-size:clamp(18px,2.2vw,28px); line-height:1.4}
  .scalable-sm{font-size:clamp(14px,1.2vw,18px); line-height:1.4}
  .badge{font-size:12px; padding:.2rem .5rem; border-radius:999px; border:1px solid rgba(255,255,255,.2)}
</style>
</head>
<body>
  <!-- HEADER -->
  <header class="max-w-7xl mx-auto px-4 pt-6 pb-4">
    <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-xl bg-indigo-500/20 grid place-items-center">
          <svg width="20" height="20" fill="none" viewBox="0 0 24 24">
            <path d="M12 3v10a4 4 0 1 1-8 0" stroke="#93a4ff" stroke-width="2" stroke-linecap="round"/>
            <rect x="10" y="2" width="4" height="12" rx="2" fill="#93a4ff"/>
            <path d="M5 13v2a7 7 0 0 0 14 0v-2" stroke="#93a4ff" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div>
          <h1 class="text-xl sm:text-2xl font-semibold">헤아림 — 노인 발음 번역기</h1>
          <p class="text-slate-400 text-sm">RAG로 개인별 과거 이력/언어데이터까지 한 화면에</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <select id="langSelect" class="glass px-3 py-2 rounded-xl"> 
          <option value="ko-KR" selected>한국어 (ko-KR)</option>
          <option value="en-US">영어 (en-US)</option>
        </select>
        <button id="btnStart" class="relative pulse px-4 py-2 rounded-xl bg-indigo-500 hover:bg-indigo-600 focus-ring">🎙️ 시작</button>
        <button id="btnStop" class="px-4 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 focus-ring">⏹️ 정지</button>
      </div>
    </div>
  </header>

  <!-- MAIN GRID -->
  <main class="max-w-7xl mx-auto px-4 pb-28">
    <div class="grid lg:grid-cols-3 gap-6">
      <!-- LEFT: MIC -->
      <section class="glass rounded-2xl p-5">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold">입력 장치</h2>
          <div class="flex items-center gap-2 text-sm text-slate-300">
            <div id="micDot" class="h-3 w-3 rounded-full bg-slate-500"></div> 마이크
          </div>
        </div>
        <div class="grid sm:grid-cols-2 gap-4">
          <div class="rounded-2xl border border-white/10 p-4 bg-white/5">
            <div class="h-16 flex items-end gap-1">
              <div class="bar bg-indigo-400"></div><div class="bar bg-indigo-400"></div><div class="bar bg-indigo-400"></div>
              <div class="bar bg-indigo-400"></div><div class="bar bg-indigo-400"></div><div class="bar bg-indigo-400"></div>
              <div class="bar bg-indigo-400"></div><div class="bar bg-indigo-400"></div><div class="bar bg-indigo-400"></div>
              <div class="bar bg-indigo-400"></div>
            </div>
            <p class="text-xs text-slate-400 mt-2">* 접근성 중심 간단 시각화</p>
          </div>
          <div class="rounded-2xl border border-white/10 p-4 bg-white/5">
            <div class="text-sm text-slate-300 mb-2">빠른 문구(테스트)</div>
            <div class="flex flex-wrap gap-2">
              <button class="quick glass px-3 py-2 rounded-xl text-sm" data-utter="물 좀... 줘보소...">“물 좀... 줘보소...”</button>
              <button class="quick glass px-3 py-2 rounded-xl text-sm" data-utter="배가 찌릿해요...">“배가 찌릿해요…”</button>
              <button class="quick glass px-3 py-2 rounded-xl text-sm" data-utter="의치가 계속 빠져요">“의치가 계속 빠져요”</button>
              <button class="quick glass px-3 py-2 rounded-xl text-sm" data-utter="화장실 어디… 급해요">“화장실 어디… 급해요”</button>
            </div>
          </div>
        </div>
        <ul class="text-slate-300 text-sm list-disc ml-5 mt-4">
          <li>짧고 천천히 말씀해 주세요.</li>
          <li>주변 소음을 줄이면 인식률이 올라갑니다.</li>
        </ul>
      </section>

      <!-- CENTER: LIVE CAPTION -->
      <section class="glass rounded-2xl p-5">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold">실황 캡션(원문)</h2>
          <div class="flex items-center gap-3">
            <label class="text-sm text-slate-300">글자 크기</label>
            <input id="fontRange" type="range" min="16" max="36" value="26" class="w-32"/>
          </div>
        </div>
        <div id="liveText" class="scalable min-h-[160px] rounded-xl border border-white/10 p-4 bg-black/20"></div>
        <div class="mt-4 flex items-center justify-between">
          <div class="text-slate-300 text-sm">부분결과는 회색, 확정문장은 파란색으로 로그에 저장됩니다.</div>
          <div class="flex gap-2">
            <button id="btnCopy"  class="px-3 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-sm">복사</button>
            <button id="btnClear" class="px-3 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-sm">초기화</button>
          </div>
        </div>
        <div id="log" class="mt-3 max-h-40 overflow-auto pr-2 shadow-scroll"></div>
      </section>

      <!-- RIGHT: TRANSLATION + INTENT + PATIENT PICKER -->
      <section class="glass rounded-2xl p-5">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold">표준문장 & 의도</h2>
          <span id="confidence" class="text-sm text-slate-400">신뢰도: -</span>
        </div>
        <div class="rounded-2xl border border-white/10 p-4 bg-white/5">
          <div class="text-slate-400 text-sm mb-1">표준문장</div>
          <div id="stdText" class="scalable text-indigo-200 font-medium">-</div>
        </div>
        <div class="grid sm:grid-cols-2 gap-3 mt-3">
          <div class="rounded-2xl border border-white/10 p-4 bg-white/5">
            <div class="text-slate-400 text-sm mb-1">의도(카테고리)</div>
            <div id="intent" class="text-lg">-</div>
          </div>
          <div class="rounded-2xl border border-white/10 p-4 bg-white/5">
            <div class="text-slate-400 text-sm mb-1">단서(매칭어)</div>
            <div id="clues" class="scalable-sm text-slate-200">-</div>
          </div>
        </div>

        <hr class="my-4 border-white/10">
        <div class="flex flex-col gap-2">
          <div class="text-slate-300 text-sm">환자 선택</div>
          <div class="flex gap-2">
            <select id="patientSelect" class="glass px-3 py-2 rounded-xl grow">
              <option value="p001" selected>p001 — 김OO(78세, F)</option>
              <option value="p002">p002 — 박OO(82세, F)</option>
              <option value="p003">p003 — 이OO(76세, M)</option>
            </select>
            <input id="ragQuery" placeholder="RAG 키워드(예: 물, 복통, 틀니)" class="glass px-3 py-2 rounded-xl w-40"/>
            <button id="btnRag" class="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500">RAG 검색</button>
          </div>
          <p class="text-xs text-slate-400">* 실제 서비스에선 인증·접근권한·감사로그 등 PHI 보호 필수</p>
        </div>
      </section>
    </div>

    <!-- BOTTOM: RAG PANELS -->
    <section class="glass rounded-2xl p-5 mt-6">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-semibold">개인별 과거 처방 이력</h2>
        <span id="rxCount" class="badge">0건</span>
      </div>
      <div class="overflow-auto rounded-xl border border-white/10">
        <table class="min-w-full text-sm">
          <thead class="bg-white/5">
            <tr class="text-left">
              <th class="px-3 py-2">날짜</th>
              <th class="px-3 py-2">진단/증상</th>
              <th class="px-3 py-2">처방약(성분)</th>
              <th class="px-3 py-2">용법</th>
              <th class="px-3 py-2">담당의</th>
            </tr>
          </thead>
          <tbody id="rxBody" class="divide-y divide-white/10"></tbody>
        </table>
      </div>
    </section>

    <section class="glass rounded-2xl p-5 mt-6">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-semibold">개인별 과거 언어데이터 (RAG Top-K)</h2>
        <div class="flex items-center gap-2">
          <span class="text-slate-300 text-sm">K</span>
          <input id="topK" type="number" min="1" max="10" value="5" class="glass w-16 px-2 py-1 rounded-lg"/>
        </div>
      </div>
      <div id="speechList" class="grid md:grid-cols-2 gap-3"></div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="max-w-7xl mx-auto px-4 py-6 text-center text-slate-500 text-sm">
    © 2025 헤아림 — 실험적 데모. 실제 운영 시 개인정보보호/동의/접근통제 필수.
  </footer>

<script>
/* -----------------------------
   0) 공통 유틸
------------------------------*/
const $ = (s)=>document.querySelector(s);
const escapeHTML = s => (s||"").replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[m]));
const highlight = (text, q) => {
  if(!q) return escapeHTML(text);
  const re = new RegExp('('+q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','gi');
  return escapeHTML(text).replace(re,'<mark>$1</mark>');
};

/* -----------------------------
   1) 의도 규칙 (간단 데모)
------------------------------*/
const KB = [
  {
    "category": "통증",
    "standard": "배가 아파요.",
    "variants": [
      "배 아파요","뱃속이 쥐나요","속이 쓰려요","배가 찌릿해요","명치가 아파요","복통이 있어요",
      "뱃심니 아프다","배가 쥐난다","배가 칼로 쑤셔요","배 아픔","배가 부르다",
      "배가 시리다예","배가 땡긴다잉","배가 뻐근허네","배 아푸","배가 꼬이는디"
    ]
  },
  {
    "category": "통증",
    "standard": "가슴이 답답해요.",
    "variants": [
      "가슴 아파요","가슴이 쪼여요","속이 꽉 막혀요","숨 막히는 느낌","명치 답답",
      "가슴이 턱 막혀","가슴이 뻐근해요","흉통 있어요","가슴답답하이","가슴이 조여온다",
      "가슴이 땡기네예","가슴이 조매 답답혀잉","가슴이 맥혀부러","가슴이 콱 막혀유"
    ]
  },
  {
    "category": "호흡곤란",
    "standard": "숨이 차요.",
    "variants": [
      "숨 가빠요","호흡이 힘들어요","헐떡여요","숨이 꽉 막혀요","숨이 안 쉬어져요",
      "숨허니","숨이 찬다예","숨이 뻐근해요","숨 넘어가겠네","숨이 턱턱 막혀요",
      "숨이 가뿌다예","숨이 고부러잉","숨이 찬거시여","숨이 히유","숨이 헉헉","숨이 후욱후욱"
    ]
  },
  {
    "category": "어지럼/실신",
    "standard": "어지러워요.",
    "variants": [
      "핑 돌아요","빙빙 돌아요","머리가 멍해요","기절할 것 같아요","휘청거려요","눈앞이 캄캄",
      "현기증 나요","머리가 핑핑 돈다","어지버벙","어지럽다예","빙빙 돈다잉","머리가 띵허네"
    ]
  },
  {
    "category": "두통",
    "standard": "머리가 아파요.",
    "variants": [
      "머리 지끈","깨질 듯 아파요","두통 있어요","머리가 띵해요","머리가 울려요","머리 뻐근해요",
      "머리 깨질랑께","머리 찡허다","머리 쪼개지겄네","머리 지끈허이","머리 아푸"
    ]
  },
  {
    "category": "근·골격 통증",
    "standard": "허리가 아파요.",
    "variants": [
      "허리 끊어질 듯","허리 뻐근","허리 삐끗","허리 욱신","허리아프다예",
      "허리 휘어지겄다","허리 뻐근허네","허리 아쎄","허리 댕겨요"
    ]
  },
  {
    "category": "구강/의치",
    "standard": "틀니가 불편해요.",
    "variants": [
      "의치가 아파요","이가 헐거워요","의치가 자꾸 빠져요","잇몸이 쓸려요","입안이 헐었어요",
      "이 불편해","입이 아파요","이 덜렁덜렁",
      "틀니가 들썩하네예","이가 덜그럭덜그럭혀","틀니가 영 불편허네","이 빠질랑말랑","의치 덜컹","이 시리다"
    ]
  },
  {
    "category": "구강건조/갈증",
    "standard": "입이 말라요.",
    "variants": [
      "목말라요","물 좀 주세요","입이 바짝바짝해요","입마름 심해요","목이 칼칼해요",
      "물 줘요","물 좀 보소","물 좀 주이소","목 마른다예","목 타분다잉","목이 칼칼허네"
    ]
  },
  {
    "category": "음료요청",
    "standard": "물 좀 주세요.",
    "variants": [
      "물 주세요","물 한 컵","목말라요","물 좀 보소","물 좀 주이소","물 좀","물…","챙겨줘요 물",
      "물 다오","물 줘","목 축이자","물 한잔 주소","물 좀 주쇼잉","물 좀 주시유"
    ]
  },
  {
    "category": "배뇨/화장실",
    "standard": "화장실 가고 싶어요.",
    "variants": [
      "볼일 좀 볼래요","쉬 마려워요","오줌 급해요","화장실 어디예요","급해요",
      "뇨 급하다","빨리 좀 데려가요","화장실 좀",
      "볼일 좀 보이소","화장실 가고 싶당께","화장실 가야허는디","쉬야 마려워","오줌 마렵다"
    ]
  },
  {
    "category": "배변",
    "standard": "배변이 안 나와요.",
    "variants": [
      "변이 안 나와요","변비예요","배가 더부룩해요","화장실 가도 시원치 않아요","응가 안 나와요",
      "똥이 안 나온다","배가 더부룩허네","응가가 안돼예","똥 마려운데 안 나와부러"
    ]
  },
  {
    "category": "소화기/구역",
    "standard": "메스꺼워요.",
    "variants": [
      "구역질나요","토할 것 같아요","속이 매스꺼워요","울렁거려요","역겹다",
      "토쏠린다","토할락해예","속이 울렁잉","속이 니글대유"
    ]
  },
  {
    "category": "발열/오한",
    "standard": "몸이 으슬으슬 떨려요.",
    "variants": [
      "오한이 와요","몸이 뜨거워요","열이 나는 것 같아요","몸살 같아요","몸이 쑤셔요",
      "몸 시리다","몸이 후끈","몸이 뜨겁다예","몸살 난거 같당께"
    ]
  },
  {
    "category": "저혈당/허기",
    "standard": "힘이 없어요.",
    "variants": [
      "기운이 쭉 빠져요","어질어질해요","당 떨어진 것 같아요","속이 울렁","손이 떨려요",
      "힘이 쭉 빠졌다예","힘이 허하다","기운이 없당께","힘이 다 나가부렀어"
    ]
  },
  {
    "category": "온·냉불편",
    "standard": "춥습니다.",
    "variants": [
      "덥습니다","냉기 들어요","덥고 답답해요","이불 좀 더","에어컨/난방 부탁해요",
      "추워죽겄다","덥다예","춥다잉","춥다유","덥네예"
    ]
  },
  {
    "category": "주사/약",
    "standard": "주사가 아파요.",
    "variants": [
      "주사 놓지 마요","약 주세요","진통제 좀","약 시간 됐나요","약이 속쓰려요","약 먹고 어지러워요",
      "주사 아프다예","약 좀 주소","약 좀 주쇼잉","약 좀 주시유"
    ]
  },
  {
    "category": "체위변경/이동",
    "standard": "자리를 좀 옮겨주세요.",
    "variants": [
      "돌려주세요","눕는 자세 바꿔요","허리가 아파서 뒤척여요","휠체어로 갈래요","침대 머리 올려요",
      "자리 옮겨주소","눕는 거 바꿔주소","뒤척여 주쇼잉","침상 올려주이소"
    ]
  },
  {
    "category": "수면",
    "standard": "잠이 안 와요.",
    "variants": [
      "잠 설쳐요","깨다 자다 해요","코골이 심해요","밤에 뒤척여요","불면이네요",
      "잠이 안 온다예","잠이 뒤숭숭해요","잠을 못 자겄네","잠이 허벌나게 안 와유"
    ]
  },
  {
    "category": "불안/정서",
    "standard": "괜히 불안해요.",
    "variants": [
      "초조해요","마음이 싱숭생숭","괜히 겁나요","예민해요","심장이 두근거려요",
      "불안허다예","마음이 두근댄다잉","마음이 싱숭생숭허네","괜히 불안허유"
    ]
  },
  {
    "category": "행정/순서",
    "standard": "진료 순서가 언제인가요?",
    "variants": [
      "제 차례 언제예요","얼마나 기다려요","번호표 몇 번이에요","대기 오래 걸리나요","순서 좀 알려줘요",
      "내 차례 언제다예","내 순서가 몇 번이여","얼마나 기다려야 쓰까","진료 언제쯤이유"
    ]
  },
  {
    "category": "행정/결과",
    "standard": "검사 결과는 언제 나오나요?",
    "variants": [
      "결과 언제 봐요","찍은 거 결과 나왔나요","피검사 언제요","영상 결과 확인됐나요",
      "결과 언제나온다예","검사 결과 언제당가","검사 언제 나오유"
    ]
  },
  {
    "category": "의료진 호출",
    "standard": "선생님은 언제 오시나요?",
    "variants": [
      "의사 언제 와요","간호사 좀 불러주세요","누구 안 오시나요","벨 안 되나요",
      "의사 언제온다예","간호사 불러주쇼","간호사 안 오시나잉","벨이 안 눌러져유"
    ]
  },
  {
    "category": "입원/퇴원",
    "standard": "퇴원은 언제 가능해요?",
    "variants": [
      "언제 나가요","입원 절차가 어떻게 돼요","수납은 어디서 하나요","보호자 서류 뭐 필요해요",
      "언제 퇴원한다예","입원 절차 좀 알려주쇼","수납은 어디다잉","퇴원 언제쯤이유"
    ]
  },
  {
    "category": "상처/출혈",
    "standard": "여기 피가 나요.",
    "variants": [
      "거즈에 피 묻어요","상처 벌어진 것 같아요","고름 나와요","봉합 터진 것 같아요",
      "피난다예","상처가 터졌다잉","피가 철철 난다","상처가 벌어져부렀어"
    ]
  },
  {
    "category": "붓기",
    "standard": "다리가 부었어요.",
    "variants": [
      "발/종아리 붓기","푸석푸석 부어요","무겁고 당겨요","한쪽만 부어요",
      "다리 붓는다예","발이 퉁퉁 붓잉","다리 뻐근허네","다리 퉁퉁 부었어유"
    ]
  }
];
function localIntentMatch(text){
  const t=(text||"").toLowerCase();
  let best={category:"-",standard:"-",clues:[],score:0};
  for(const item of KB){
    let score=0, clues=[];
    for(const v of item.variants){
      const vv=v.replace(/\s+/g,"").toLowerCase();
      if(t.includes(vv) || t.includes(v.toLowerCase())){ score++; clues.push(v); }
    }
    if(score>best.score) best={category:item.category, standard:item.standard, clues, score};
  }
  const conf=best.score===0?0.2:Math.min(0.2+best.score*0.2,0.95);
  return {...best, confidence: conf};
}

/* -----------------------------
   2) 데모용 환자 데이터 (실제에선 DB/RAG)
------------------------------*/
const DEMO = {
  p001:{
    rx:[
      {date:"2025-06-10", dx:"상복부 통증(위염 의심)", drug:"PPI(esomeprazole 20mg)", dose:"1정 qd 아침 식전", doctor:"정OO"},
      {date:"2025-03-02", dx:"구강 통증(의치 압통)",   drug:"Acetaminophen 500mg",   dose:"1정 tid 필요시", doctor:"유OO"},
      {date:"2024-12-21", dx:"탈수 의심",              drug:"ORS 경구수액",          dose:"포 1개 필요시",  doctor:"정OO"},
    ],
    speech:[
      {text:"몰줌… 목이 칼칼하다 카이", context:"오후 외래 대기 중 물 요청", tags:["음료요청"], score:0.86},
      {text:"이가 덜그럭거리고 씹기 힘들어예", context:"의치 불편 호소", tags:["구강/의치"], score:0.82},
      {text:"속이 쓰려가꼬 밥 맛이 없데이", context:"소화불량/위염 의심", tags:["통증"], score:0.79},
      {text:"볼일 좀 급한데 화장실 어딥니꺼", context:"화장실 위치 문의", tags:["화장실"], score:0.77},
      {text:"목 타 죽겠다 아이가", context:"더위/탈수 의심", tags:["음료요청"], score:0.74},
    ]
  },
  p002:{
    rx:[
      {date:"2025-07-01", dx:"요로감염 치료", drug:"Ciprofloxacin 250mg", dose:"1정 bid 7일", doctor:"박OO"},
      {date:"2025-01-14", dx:"무릎 통증", drug:"NSAIDs(Naproxen 250mg)", dose:"1정 bid 식후", doctor:"김OO"},
    ],
    speech:[
      {text:"물 한 잔만 주소", context:"접수 창구", tags:["음료요청"], score:0.81},
      {text:"쉬 마려워요…", context:"진료 전", tags:["화장실"], score:0.78},
      {text:"이가 헐거워서 밥을 못 먹어", context:"영양 섭취곤란", tags:["구강/의치"], score:0.76},
    ]
  },
  p003:{
    rx:[
      {date:"2025-05-09", dx:"요통", drug:"Acetaminophen 500mg", dose:"1정 tid", doctor:"남OO"},
    ],
    speech:[
      {text:"배가 찌릿하네", context:"응급실 트리아지", tags:["통증"], score:0.69},
      {text:"화장실… 급해요", context:"복도", tags:["화장실"], score:0.67},
    ]
  }
};

/* -----------------------------
   3) (선택) 백엔드 연동 훅
   실제 서비스에선 이 자리에 fetch('/api/rag/...') 사용
------------------------------*/
async function fetchPrescriptions(patientId, query){
  // const r = await fetch('/api/rag/prescriptions',{method:'POST',headers:{'Content-Type':'application/json'}, body:JSON.stringify({patientId, query})});
  // return await r.json();
  const rows = (DEMO[patientId]?.rx||[])
    .filter(r=>!query || JSON.stringify(r).toLowerCase().includes(query.toLowerCase()));
  return rows;
}
async function fetchSpeechRAG(patientId, query, topK=5){
  // const r = await fetch('/api/rag/speech',{method:'POST',headers:{'Content-Type':'application/json'}, body:JSON.stringify({patientId, query, topK})});
  // return await r.json();
  let items = (DEMO[patientId]?.speech||[]);
  if(query){
    // 간단 키워드 가중치
    const q = query.toLowerCase();
    items = items.map(o=>{
      const hit = (o.text+o.context+o.tags.join(',')).toLowerCase().includes(q);
      return {...o, score: o.score + (hit?0.05:0)};
    });
  }
  return items.sort((a,b)=>b.score-a.score).slice(0, topK);
}

/* -----------------------------
   4) UI 바인딩
------------------------------*/
const liveText = $('#liveText'), log = $('#log'), stdText = $('#stdText'), intentEl = $('#intent'), cluesEl = $('#clues'), confEl = $('#confidence');
const micDot = $('#micDot'); const btnStart = $('#btnStart'); const btnStop = $('#btnStop'); const fontRange = $('#fontRange'); const langSelect = $('#langSelect');
const btnCopy = $('#btnCopy'); const btnClear = $('#btnClear');
const patientSelect = $('#patientSelect'); const ragQuery = $('#ragQuery'); const btnRag = $('#btnRag'); const rxBody = $('#rxBody'); const rxCount = $('#rxCount');
const speechList = $('#speechList'); const topK = $('#topK');

let recognizing=false, recognition=null;

function appendLog(text, final=false){
  const line=document.createElement('div'); line.className='mb-1';
  const badge = final? '<span class="text-xs px-2 py-0.5 rounded-full bg-indigo-500/30 border border-indigo-400/30 mr-2">확정</span>'
                     : '<span class="text-xs px-2 py-0.5 rounded-full bg-slate-500/30 border border-slate-400/30 mr-2">부분</span>';
  line.innerHTML = badge + `<span class="${final?'text-indigo-200':'text-slate-300'}">${escapeHTML(text)}</span>`;
  log.appendChild(line); log.scrollTop = log.scrollHeight;
}
function setMic(on){ micDot.className='h-3 w-3 rounded-full '+(on?'bg-emerald-400':'bg-slate-500'); }

function renderRx(rows, q){
  rxBody.innerHTML = rows.map(r=>`
    <tr>
      <td class="px-3 py-2 whitespace-nowrap">${highlight(r.date,q)}</td>
      <td class="px-3 py-2">${highlight(r.dx,q)}</td>
      <td class="px-3 py-2">${highlight(r.drug,q)}</td>
      <td class="px-3 py-2">${highlight(r.dose,q)}</td>
      <td class="px-3 py-2 whitespace-nowrap">${highlight(r.doctor,q)}</td>
    </tr>`).join('');
  rxCount.textContent = `${rows.length}건`;
}
function renderSpeech(items, q){
  speechList.innerHTML = items.map(o=>`
    <div class="rounded-xl border border-white/10 p-4 bg-white/5">
      <div class="flex items-center justify-between mb-1">
        <div class="badge">${(o.score*100).toFixed(0)}점</div>
        <div class="text-xs text-slate-400">${o.tags.map(t=>`#${t}`).join(' ')}</div>
      </div>
      <div class="font-medium mb-1">${highlight(o.text,q)}</div>
      <div class="text-sm text-slate-300">맥락: ${highlight(o.context,q)}</div>
    </div>`).join('');
}

async function runRAG(){
  const pid = patientSelect.value, q = ragQuery.value.trim();
  const [rx, sp] = await Promise.all([fetchPrescriptions(pid,q), fetchSpeechRAG(pid,q, +topK.value || 5)]);
  renderRx(rx, q); renderSpeech(sp, q);
}
btnRag.addEventListener('click', runRAG);
patientSelect.addEventListener('change', runRAG);
topK.addEventListener('change', runRAG);
ragQuery.addEventListener('keydown', (e)=>{ if(e.key==='Enter') runRAG(); });

/* -----------------------------
   5) (데모) Web Speech API
------------------------------*/
function initRecognition(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ alert("이 브라우저는 실시간 음성 인식을 지원하지 않습니다. Chrome 권장 또는 백엔드 ASR 연결을 사용하세요."); return null; }
  const rec = new SR(); rec.continuous = true; rec.interimResults = true; rec.lang = langSelect.value||'ko-KR'; rec.maxAlternatives=1;
  rec.onstart = ()=>{ recognizing=true; setMic(true); };
  rec.onend   = ()=>{ recognizing=false; setMic(false); };
  rec.onresult = async (event)=>{
    let interim='', finalText='';
    for(let i=event.resultIndex;i<event.results.length;i++){
      const res=event.results[i]; const t=res[0].transcript.trim();
      if(res.isFinal){ finalText += t + ' '; } else { interim += t + ' '; }
    }
    if(interim){
      liveText.innerHTML = `<span class="text-slate-300">${escapeHTML(interim)}</span>`;
      appendLog(interim,false);
      const r=localIntentMatch(interim);
      stdText.textContent = r.standard!=="-"?r.standard:interim;
      intentEl.textContent = r.category||'-';
      cluesEl.textContent = r.clues?.join(', ')||'-';
      confEl.textContent = `신뢰도: ${Math.round((r.confidence||0)*100)}%`;
    }
    if(finalText){
      liveText.innerHTML = `<span class="text-indigo-200">${escapeHTML(finalText)}</span>`;
      appendLog(finalText,true);
      const r=localIntentMatch(finalText);
      stdText.textContent = r.standard!=="-"?r.standard:finalText;
      intentEl.textContent = r.category||'-';
      cluesEl.textContent = r.clues?.join(', ')||'-';
      confEl.textContent = `신뢰도: ${Math.round((r.confidence||0)*100)}%`;
    }
  };
  return rec;
}

btnStart.addEventListener('click', ()=>{
  if(recognizing) return;
  recognition = initRecognition();
  if(recognition){ recognition.lang = langSelect.value; recognition.start(); }
});
btnStop.addEventListener('click', ()=>{ if(recognition && recognizing) recognition.stop(); });
fontRange.addEventListener('input', e=>{ const px=e.target.value+'px'; liveText.style.fontSize=px; stdText.style.fontSize=px; });
btnCopy.addEventListener('click', ()=>{
  const texts=[...log.querySelectorAll('div span:last-child')].map(n=>n.textContent.trim()).join('\n');
  navigator.clipboard.writeText(texts || (liveText.textContent||''));
});
btnClear.addEventListener('click', ()=>{ log.innerHTML=''; liveText.textContent=''; stdText.textContent='-'; intentEl.textContent='-'; cluesEl.textContent='-'; confEl.textContent='신뢰도: -'; });

/* 초기 로드 시 기본 RAG 채움 */
runRAG();
</script>
</body>
</html>
